<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>libctru: network/uds/source/uds.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libctru
   &#160;<span id="projectnumber">v1.4.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">network/uds/source/uds.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;malloc.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdarg.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="3ds_8h.html">3ds.h</a>&gt;</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> print_constatus()</div><div class="line">{</div><div class="line">    <a class="code" href="types_8h.html#ac830bf5a4f2cf8273f61ab99a46cf163">Result</a> ret=0;</div><div class="line">    <a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> pos;</div><div class="line">    <a name="_a0"></a><a class="code" href="structudsConnectionStatus.html">udsConnectionStatus</a> constatus;</div><div class="line"></div><div class="line">    <span class="comment">//By checking the output of udsGetConnectionStatus you can check for nodes (including the current one) which just (dis)connected, etc.</span></div><div class="line">    ret = <a name="a1"></a><a class="code" href="uds_8h.html#a7fdd55dbeca432e2ad83dccc203d6de4">udsGetConnectionStatus</a>(&amp;constatus);</div><div class="line">    <span class="keywordflow">if</span>(<a name="a2"></a><a class="code" href="result_8h.html#a0b5d96e53599ca10d46297ba05e20b62">R_FAILED</a>(ret))</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;udsGetConnectionStatus() returned 0x%08x.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)ret);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;constatus:\nstatus=0x%x\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)constatus.<a name="a3"></a>status);</div><div class="line">        printf(<span class="stringliteral">&quot;1=0x%x\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)constatus.<a name="a4"></a>unk_x4);</div><div class="line">        printf(<span class="stringliteral">&quot;cur_NetworkNodeID=0x%x\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)constatus.<a name="a5"></a>cur_NetworkNodeID);</div><div class="line">        printf(<span class="stringliteral">&quot;unk_xa=0x%x\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)constatus.<a name="a6"></a>unk_xa);</div><div class="line">        <span class="keywordflow">for</span>(pos=0; pos&lt;(0x20&gt;&gt;2); pos++)printf(<span class="stringliteral">&quot;%u=0x%x &quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)pos+3, (<span class="keywordtype">unsigned</span> int)constatus.<a name="a7"></a>unk_xc[pos]);</div><div class="line">        printf(<span class="stringliteral">&quot;\ntotal_nodes=0x%x\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)constatus.<a name="a8"></a>total_nodes);</div><div class="line">        printf(<span class="stringliteral">&quot;max_nodes=0x%x\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)constatus.<a name="a9"></a>max_nodes);</div><div class="line">        printf(<span class="stringliteral">&quot;node_bitmask=0x%x\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)constatus.total_nodes);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> uds_test()</div><div class="line">{</div><div class="line">    <a class="code" href="types_8h.html#ac830bf5a4f2cf8273f61ab99a46cf163">Result</a> ret=0;</div><div class="line">    <a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> con_type=0;</div><div class="line"></div><div class="line">    <a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> *tmpbuf;</div><div class="line">    <span class="keywordtype">size_t</span> tmpbuf_size;</div><div class="line"></div><div class="line">    <a class="code" href="types_8h.html#a92c50087ca0e64fa93fc59402c55f8ca">u8</a> data_channel = 1;</div><div class="line">    <a name="_a10"></a><a class="code" href="structudsNetworkStruct.html">udsNetworkStruct</a> networkstruct;</div><div class="line">    <a name="_a11"></a><a class="code" href="structudsBindContext.html">udsBindContext</a> bindctx;</div><div class="line">    <a name="_a12"></a><a class="code" href="structudsNetworkScanInfo.html">udsNetworkScanInfo</a> *networks = NULL;</div><div class="line">    <a class="code" href="structudsNetworkScanInfo.html">udsNetworkScanInfo</a> *network = NULL;</div><div class="line">    <span class="keywordtype">size_t</span> total_networks = 0;</div><div class="line"></div><div class="line">    <a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> recv_buffer_size = <a name="a13"></a><a class="code" href="uds_8h.html#aaa762c12085c0caf4cc3c380621a66b3">UDS_DEFAULT_RECVBUFSIZE</a>;</div><div class="line">    <a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> wlancommID = 0x48425710;<span class="comment">//Unique ID, change this to your own.</span></div><div class="line">    <span class="keywordtype">char</span> *passphrase = <span class="stringliteral">&quot;udsdemo passphrase c186093cd2652741&quot;</span>;<span class="comment">//Change this passphrase to your own. The input you use for the passphrase doesn&#39;t matter since it&#39;s a raw buffer.</span></div><div class="line"></div><div class="line">    udsConnectionType conntype = UDSCONTYPE_Client;</div><div class="line"></div><div class="line">    <a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> transfer_data, prev_transfer_data = 0;</div><div class="line">    <span class="keywordtype">size_t</span> actual_size;</div><div class="line">    <a class="code" href="types_8h.html#ace9d960e74685e2cd84b36132dbbf8aa">u16</a> src_NetworkNodeID;</div><div class="line">    <a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> tmp=0;</div><div class="line">    <a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> pos;</div><div class="line"></div><div class="line">    <a name="_a14"></a><a class="code" href="structudsNodeInfo.html">udsNodeInfo</a> tmpnode;</div><div class="line"></div><div class="line">    <a class="code" href="types_8h.html#a92c50087ca0e64fa93fc59402c55f8ca">u8</a> appdata[0x14] = {0x69, 0x8a, 0x05, 0x5c};</div><div class="line">    <a class="code" href="types_8h.html#a92c50087ca0e64fa93fc59402c55f8ca">u8</a> out_appdata[0x14];</div><div class="line"></div><div class="line">    <span class="keywordtype">char</span> tmpstr[256];</div><div class="line"></div><div class="line">    strncpy((<span class="keywordtype">char</span>*)&amp;appdata[4], <span class="stringliteral">&quot;Test appdata.&quot;</span>, <span class="keyword">sizeof</span>(appdata)-4);</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;Successfully initialized.\n&quot;</span>);</div><div class="line"></div><div class="line">    tmpbuf_size = 0x4000;</div><div class="line">    tmpbuf = malloc(tmpbuf_size);</div><div class="line">    <span class="keywordflow">if</span>(tmpbuf==NULL)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Failed to allocate tmpbuf for beacon data.\n&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">//With normal client-side handling you&#39;d keep running network-scanning until the user chooses to stops scanning or selects a network to connect to. This example just scans a maximum of 10 times until at least one network is found.</span></div><div class="line">    <span class="keywordflow">for</span>(pos=0; pos&lt;10; pos++)</div><div class="line">    {</div><div class="line">        total_networks = 0;</div><div class="line">        memset(tmpbuf, 0, <span class="keyword">sizeof</span>(tmpbuf_size));</div><div class="line">        ret = <a name="a15"></a><a class="code" href="uds_8h.html#a2af058b5911c1755a1d0a486962048c2">udsScanBeacons</a>(tmpbuf, tmpbuf_size, &amp;networks, &amp;total_networks, wlancommID, 0, NULL, <span class="keyword">false</span>);</div><div class="line">        printf(<span class="stringliteral">&quot;udsScanBeacons() returned 0x%08x.\ntotal_networks=%u.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)ret, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)total_networks);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(total_networks)<span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    free(tmpbuf);</div><div class="line">    tmpbuf = NULL;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span>(total_networks)</div><div class="line">    {</div><div class="line">        <span class="comment">//At this point you&#39;d let the user select which network to connect to and optionally display the first node&#39;s username(the host), along with the parsed appdata if you want. For this example this just uses the first detected network and then displays the username of each node.</span></div><div class="line">        <span class="comment">//If appdata isn&#39;t enough, you can do what DLP does loading the icon data etc: connect to the network as a spectator temporarily for receiving broadcasted data frames.</span></div><div class="line"></div><div class="line">        network = &amp;networks[0];</div><div class="line"></div><div class="line">        printf(<span class="stringliteral">&quot;network: total nodes = %u.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)network-&gt;<a name="a16"></a>network.<a name="a17"></a>total_nodes);</div><div class="line"></div><div class="line">        <span class="keywordflow">for</span>(pos=0; pos&lt;<a name="a18"></a><a class="code" href="uds_8h.html#af550f39aed337de1ec8f99823c3dc886">UDS_MAXNODES</a>; pos++)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span>(!<a name="a19"></a><a class="code" href="uds_8h.html#a8d326aaf8ff13eb9041730bf86374fe0">udsCheckNodeInfoInitialized</a>(&amp;network-&gt;<a name="a20"></a>nodes[pos]))<span class="keywordflow">continue</span>;</div><div class="line"></div><div class="line">            memset(tmpstr, 0, <span class="keyword">sizeof</span>(tmpstr));</div><div class="line"></div><div class="line">            ret = <a name="a21"></a><a class="code" href="uds_8h.html#aa1a1a204b83acf4615b1d2a870681272">udsGetNodeInfoUsername</a>(&amp;network-&gt;nodes[pos], tmpstr);</div><div class="line">            <span class="keywordflow">if</span>(<a class="code" href="result_8h.html#a0b5d96e53599ca10d46297ba05e20b62">R_FAILED</a>(ret))</div><div class="line">            {</div><div class="line">                printf(<span class="stringliteral">&quot;udsGetNodeInfoUsername() returned 0x%08x.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)ret);</div><div class="line">                free(networks);</div><div class="line">                <span class="keywordflow">return</span>;</div><div class="line">            }</div><div class="line"></div><div class="line">            printf(<span class="stringliteral">&quot;node%u username: %s\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)pos, tmpstr);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">//You can load appdata from the scanned beacon data here if you want.</span></div><div class="line">        actual_size = 0;</div><div class="line">        ret = <a name="a22"></a><a class="code" href="uds_8h.html#ab3ffe31c0e34aba040548dc56abb001d">udsGetNetworkStructApplicationData</a>(&amp;network-&gt;network, out_appdata, <span class="keyword">sizeof</span>(out_appdata), &amp;actual_size);</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="result_8h.html#a0b5d96e53599ca10d46297ba05e20b62">R_FAILED</a>(ret) || actual_size!=<span class="keyword">sizeof</span>(out_appdata))</div><div class="line">        {</div><div class="line">            printf(<span class="stringliteral">&quot;udsGetNetworkStructApplicationData() returned 0x%08x. actual_size = 0x%x.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)ret, actual_size);</div><div class="line">            free(networks);</div><div class="line">            <span class="keywordflow">return</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        memset(tmpstr, 0, <span class="keyword">sizeof</span>(tmpstr));</div><div class="line">        <span class="keywordflow">if</span>(memcmp(out_appdata, appdata, 4)!=0)</div><div class="line">        {</div><div class="line">            printf(<span class="stringliteral">&quot;The first 4-bytes of appdata is invalid.\n&quot;</span>);</div><div class="line">            free(networks);</div><div class="line">            <span class="keywordflow">return</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        strncpy(tmpstr, (<span class="keywordtype">char</span>*)&amp;out_appdata[4], <span class="keyword">sizeof</span>(out_appdata)-5);</div><div class="line">        printf(<span class="stringliteral">&quot;String from network appdata: %s\n&quot;</span>, (<span class="keywordtype">char</span>*)&amp;out_appdata[4]);</div><div class="line"></div><div class="line">        <a name="a23"></a><a class="code" href="hid_8h.html#abbbf0e1f3a79a75e459e19f85a66bee6">hidScanInput</a>();<span class="comment">//Normally you would only connect as a regular client.</span></div><div class="line">        <span class="keywordflow">if</span>(<a name="a24"></a><a class="code" href="hid_8h.html#a68e8fd75a99650db835f045676a47949">hidKeysHeld</a>() &amp; <a name="a25"></a><a class="code" href="hid_8h.html#a84627a72058502328269676b81780f89aece16de35a5ea11f9b228c9376bebc62">KEY_L</a>)</div><div class="line">        {</div><div class="line">            conntype = UDSCONTYPE_Spectator;</div><div class="line">            printf(<span class="stringliteral">&quot;Connecting to the network as a spectator...\n&quot;</span>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">            printf(<span class="stringliteral">&quot;Connecting to the network as a client...\n&quot;</span>);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">for</span>(pos=0; pos&lt;10; pos++)</div><div class="line">        {</div><div class="line">            ret = <a name="a26"></a><a class="code" href="uds_8h.html#a667dabaed66dd32770a6ede4fd818019">udsConnectNetwork</a>(&amp;network-&gt;network, passphrase, strlen(passphrase)+1, &amp;bindctx, <a name="a27"></a><a class="code" href="uds_8h.html#a0716197ea3205d2c2ad802fd39d64b53">UDS_BROADCAST_NETWORKNODEID</a>, conntype, data_channel, recv_buffer_size);</div><div class="line">            <span class="keywordflow">if</span>(<a class="code" href="result_8h.html#a0b5d96e53599ca10d46297ba05e20b62">R_FAILED</a>(ret))</div><div class="line">            {</div><div class="line">                printf(<span class="stringliteral">&quot;udsConnectNetwork() returned 0x%08x.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)ret);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        free(networks);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(pos==10)<span class="keywordflow">return</span>;</div><div class="line"></div><div class="line">        printf(<span class="stringliteral">&quot;Connected.\n&quot;</span>);</div><div class="line"></div><div class="line">        tmp = 0;</div><div class="line">        ret = <a name="a28"></a><a class="code" href="uds_8h.html#a682ad1bee0b482a496d03a6d88ec5c0c">udsGetChannel</a>((<a class="code" href="types_8h.html#a92c50087ca0e64fa93fc59402c55f8ca">u8</a>*)&amp;tmp);<span class="comment">//Normally you don&#39;t need to use this.</span></div><div class="line">        printf(<span class="stringliteral">&quot;udsGetChannel() returned 0x%08x. channel = %u.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)ret, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)tmp);</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="result_8h.html#a0b5d96e53599ca10d46297ba05e20b62">R_FAILED</a>(ret))</div><div class="line">        {</div><div class="line">            <span class="keywordflow">return</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">//You can load the appdata with this once connected to the network, if you want.</span></div><div class="line">        memset(out_appdata, 0, <span class="keyword">sizeof</span>(out_appdata));</div><div class="line">        actual_size = 0;</div><div class="line">        ret = <a name="a29"></a><a class="code" href="uds_8h.html#aa10484f4b741649b48633efafdfb8e55">udsGetApplicationData</a>(out_appdata, <span class="keyword">sizeof</span>(out_appdata), &amp;actual_size);</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="result_8h.html#a0b5d96e53599ca10d46297ba05e20b62">R_FAILED</a>(ret) || actual_size!=<span class="keyword">sizeof</span>(out_appdata))</div><div class="line">        {</div><div class="line">            printf(<span class="stringliteral">&quot;udsGetApplicationData() returned 0x%08x. actual_size = 0x%x.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)ret, actual_size);</div><div class="line">            <a name="a30"></a><a class="code" href="uds_8h.html#a300ee4358ee07e1b08dea6e1908e72a6">udsDisconnectNetwork</a>();</div><div class="line">            <a name="a31"></a><a class="code" href="uds_8h.html#a0478019d97df6c5754cae576b2fecbbd">udsUnbind</a>(&amp;bindctx);</div><div class="line">            <span class="keywordflow">return</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        memset(tmpstr, 0, <span class="keyword">sizeof</span>(tmpstr));</div><div class="line">        <span class="keywordflow">if</span>(memcmp(out_appdata, appdata, 4)!=0)</div><div class="line">        {</div><div class="line">            printf(<span class="stringliteral">&quot;The first 4-bytes of appdata is invalid.\n&quot;</span>);</div><div class="line">            <a class="code" href="uds_8h.html#a300ee4358ee07e1b08dea6e1908e72a6">udsDisconnectNetwork</a>();</div><div class="line">            <a class="code" href="uds_8h.html#a0478019d97df6c5754cae576b2fecbbd">udsUnbind</a>(&amp;bindctx);</div><div class="line">            <span class="keywordflow">return</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        strncpy(tmpstr, (<span class="keywordtype">char</span>*)&amp;out_appdata[4], <span class="keyword">sizeof</span>(out_appdata)-5);</div><div class="line">        printf(<span class="stringliteral">&quot;String from appdata: %s\n&quot;</span>, (<span class="keywordtype">char</span>*)&amp;out_appdata[4]);</div><div class="line"></div><div class="line">        con_type = 1;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <a name="a32"></a><a class="code" href="uds_8h.html#ae2bc9475be5af0d5e1ee3a5f98855b89">udsGenerateDefaultNetworkStruct</a>(&amp;networkstruct, wlancommID, 0, <a class="code" href="uds_8h.html#af550f39aed337de1ec8f99823c3dc886">UDS_MAXNODES</a>);</div><div class="line"></div><div class="line">        printf(<span class="stringliteral">&quot;Creating the network...\n&quot;</span>);</div><div class="line">        ret = <a name="a33"></a><a class="code" href="uds_8h.html#a1975ed5bb92b1a1c87de5bfb41588847">udsCreateNetwork</a>(&amp;networkstruct, passphrase, strlen(passphrase)+1, &amp;bindctx, data_channel, recv_buffer_size);</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="result_8h.html#a0b5d96e53599ca10d46297ba05e20b62">R_FAILED</a>(ret))</div><div class="line">        {</div><div class="line">            printf(<span class="stringliteral">&quot;udsCreateNetwork() returned 0x%08x.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)ret);</div><div class="line">            <span class="keywordflow">return</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        ret = <a name="a34"></a><a class="code" href="uds_8h.html#a6d31b5879de5cec14eff252093d1c88d">udsSetApplicationData</a>(appdata, <span class="keyword">sizeof</span>(appdata));<span class="comment">//If you want to use appdata, you can set the appdata whenever you want after creating the network. If you need more space for appdata, you can set different chunks of appdata over time.</span></div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="result_8h.html#a0b5d96e53599ca10d46297ba05e20b62">R_FAILED</a>(ret))</div><div class="line">        {</div><div class="line">            printf(<span class="stringliteral">&quot;udsSetApplicationData() returned 0x%08x.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)ret);</div><div class="line">            <a name="a35"></a><a class="code" href="uds_8h.html#a44092fac3eec0cb9402fd903dc2fff81">udsDestroyNetwork</a>();</div><div class="line">            <a class="code" href="uds_8h.html#a0478019d97df6c5754cae576b2fecbbd">udsUnbind</a>(&amp;bindctx);</div><div class="line">            <span class="keywordflow">return</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        tmp = 0;</div><div class="line">        ret = <a class="code" href="uds_8h.html#a682ad1bee0b482a496d03a6d88ec5c0c">udsGetChannel</a>((<a class="code" href="types_8h.html#a92c50087ca0e64fa93fc59402c55f8ca">u8</a>*)&amp;tmp);<span class="comment">//Normally you don&#39;t need to use this.</span></div><div class="line">        printf(<span class="stringliteral">&quot;udsGetChannel() returned 0x%08x. channel = %u.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)ret, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)tmp);</div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="result_8h.html#a0b5d96e53599ca10d46297ba05e20b62">R_FAILED</a>(ret))</div><div class="line">        {</div><div class="line">            <a class="code" href="uds_8h.html#a44092fac3eec0cb9402fd903dc2fff81">udsDestroyNetwork</a>();</div><div class="line">            <a class="code" href="uds_8h.html#a0478019d97df6c5754cae576b2fecbbd">udsUnbind</a>(&amp;bindctx);</div><div class="line">            <span class="keywordflow">return</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        con_type = 0;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span>(<a name="a36"></a><a class="code" href="uds_8h.html#a3e5c7256539d252195695c5503d64255">udsWaitConnectionStatusEvent</a>(<span class="keyword">false</span>, <span class="keyword">false</span>))</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Constatus event signaled.\n&quot;</span>);</div><div class="line">        print_constatus();</div><div class="line">    }</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;Press A to stop data transfer.\n&quot;</span>);</div><div class="line"></div><div class="line">    tmpbuf_size = <a name="a37"></a><a class="code" href="uds_8h.html#a925d4cb65dc18dace5cfbd4115149a70">UDS_DATAFRAME_MAXSIZE</a>;</div><div class="line">    tmpbuf = malloc(tmpbuf_size);</div><div class="line">    <span class="keywordflow">if</span>(tmpbuf==NULL)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Failed to allocate tmpbuf for receiving data.\n&quot;</span>);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(con_type)</div><div class="line">        {</div><div class="line">            <a class="code" href="uds_8h.html#a44092fac3eec0cb9402fd903dc2fff81">udsDestroyNetwork</a>();</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">            <a class="code" href="uds_8h.html#a300ee4358ee07e1b08dea6e1908e72a6">udsDisconnectNetwork</a>();</div><div class="line">        }</div><div class="line">        <a class="code" href="uds_8h.html#a0478019d97df6c5754cae576b2fecbbd">udsUnbind</a>(&amp;bindctx);</div><div class="line"></div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span>(1)</div><div class="line">    {</div><div class="line">        <a name="a38"></a><a class="code" href="gspgpu_8h.html#abf0a992835649b5fe90e95d8a58b8c45">gspWaitForVBlank</a>();</div><div class="line">        <a class="code" href="hid_8h.html#abbbf0e1f3a79a75e459e19f85a66bee6">hidScanInput</a>();</div><div class="line">        <a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> kDown = <a name="a39"></a><a class="code" href="hid_8h.html#aa2cababf764bf0b4297dc2e2fffe2a76">hidKeysDown</a>();</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(kDown &amp; <a name="a40"></a><a class="code" href="hid_8h.html#a84627a72058502328269676b81780f89aa7b3a3d0503a46bec51c6e3da95747cc">KEY_A</a>)<span class="keywordflow">break</span>;</div><div class="line">        prev_transfer_data = transfer_data;</div><div class="line">        transfer_data = <a class="code" href="hid_8h.html#a68e8fd75a99650db835f045676a47949">hidKeysHeld</a>();</div><div class="line"></div><div class="line">        <span class="comment">//When the output from hidKeysHeld() changes, send it over the network.</span></div><div class="line">        <span class="keywordflow">if</span>(transfer_data != prev_transfer_data &amp;&amp; conntype!=UDSCONTYPE_Spectator)<span class="comment">//Spectators aren&#39;t allowed to send data.</span></div><div class="line">        {</div><div class="line">            ret = <a name="a41"></a><a class="code" href="uds_8h.html#a2609972c60a77f6cfbd85c4caab93c70">udsSendTo</a>(<a class="code" href="uds_8h.html#a0716197ea3205d2c2ad802fd39d64b53">UDS_BROADCAST_NETWORKNODEID</a>, data_channel, UDS_SENDFLAG_Default, &amp;transfer_data, <span class="keyword">sizeof</span>(transfer_data));</div><div class="line">            <span class="keywordflow">if</span>(<a name="a42"></a><a class="code" href="uds_8h.html#a95b9889070392e10ed0ce8eaa4680148">UDS_CHECK_SENDTO_FATALERROR</a>(ret))</div><div class="line">            {</div><div class="line">                printf(<span class="stringliteral">&quot;udsSendTo() returned 0x%08x.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)ret);</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">//if(udsWaitDataAvailable(&amp;bindctx, false, false))//Check whether data is available via udsPullPacket().</span></div><div class="line">        {</div><div class="line">            memset(tmpbuf, 0, tmpbuf_size);</div><div class="line">            actual_size = 0;</div><div class="line">            src_NetworkNodeID = 0;</div><div class="line">            ret = <a name="a43"></a><a class="code" href="uds_8h.html#a15464b1fc2ce4897f352001b59b40597">udsPullPacket</a>(&amp;bindctx, tmpbuf, tmpbuf_size, &amp;actual_size, &amp;src_NetworkNodeID);</div><div class="line">            <span class="keywordflow">if</span>(<a class="code" href="result_8h.html#a0b5d96e53599ca10d46297ba05e20b62">R_FAILED</a>(ret))</div><div class="line">            {</div><div class="line">                printf(<span class="stringliteral">&quot;udsPullPacket() returned 0x%08x.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)ret);</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span>(actual_size)<span class="comment">//If no data frame is available, udsPullPacket() will return actual_size=0.</span></div><div class="line">            {</div><div class="line">                printf(<span class="stringliteral">&quot;Received 0x%08x size=0x%08x from node 0x%x.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)tmpbuf[0], actual_size, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)src_NetworkNodeID);</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(kDown &amp; <a name="a44"></a><a class="code" href="hid_8h.html#a84627a72058502328269676b81780f89a5d44524b2a6090fa97aa9353d69f67a3">KEY_Y</a>)</div><div class="line">        {</div><div class="line">            ret = <a name="a45"></a><a class="code" href="uds_8h.html#a96d9f0e9574e21527b4f258b4a0f54ee">udsGetNodeInformation</a>(0x2, &amp;tmpnode);<span class="comment">//This can be used to get the NodeInfo for a node which just connected, for example.</span></div><div class="line">            <span class="keywordflow">if</span>(<a class="code" href="result_8h.html#a0b5d96e53599ca10d46297ba05e20b62">R_FAILED</a>(ret))</div><div class="line">            {</div><div class="line">                printf(<span class="stringliteral">&quot;udsGetNodeInformation() returned 0x%08x.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)ret);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                memset(tmpstr, 0, <span class="keyword">sizeof</span>(tmpstr));</div><div class="line"></div><div class="line">                ret = <a class="code" href="uds_8h.html#aa1a1a204b83acf4615b1d2a870681272">udsGetNodeInfoUsername</a>(&amp;tmpnode, tmpstr);</div><div class="line">                <span class="keywordflow">if</span>(<a class="code" href="result_8h.html#a0b5d96e53599ca10d46297ba05e20b62">R_FAILED</a>(ret))</div><div class="line">                {</div><div class="line">                    printf(<span class="stringliteral">&quot;udsGetNodeInfoUsername() returned 0x%08x for udsGetNodeInfoUsername.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)ret);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                    printf(<span class="stringliteral">&quot;node username: %s\n&quot;</span>, tmpstr);</div><div class="line">                    printf(<span class="stringliteral">&quot;node unk_x1c=0x%x\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)tmpnode.<a name="a46"></a>unk_x1c);</div><div class="line">                    printf(<span class="stringliteral">&quot;node flag=0x%x\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)tmpnode.<a name="a47"></a>flag);</div><div class="line">                    printf(<span class="stringliteral">&quot;node pad_x1f=0x%x\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)tmpnode.<a name="a48"></a>pad_x1f);</div><div class="line">                    printf(<span class="stringliteral">&quot;node NetworkNodeID=0x%x\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)tmpnode.<a name="a49"></a>NetworkNodeID);</div><div class="line">                    printf(<span class="stringliteral">&quot;node word_x24=0x%x\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)tmpnode.<a name="a50"></a>word_x24);</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(kDown &amp; <a name="a51"></a><a class="code" href="hid_8h.html#a84627a72058502328269676b81780f89a480a807305121d41673b8c208898f497">KEY_X</a>)<span class="comment">//Block new regular clients from connecting.</span></div><div class="line">        {</div><div class="line">            ret = <a name="a52"></a><a class="code" href="uds_8h.html#a579487b86069a0a066bf6973f3d94dd7">udsSetNewConnectionsBlocked</a>(<span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</div><div class="line">            printf(<span class="stringliteral">&quot;udsSetNewConnectionsBlocked() for enabling blocking returned 0x%08x.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)ret);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(kDown &amp; <a name="a53"></a><a class="code" href="hid_8h.html#a84627a72058502328269676b81780f89a10072b5ee7aa1faf316434ecc9e2bb3a">KEY_B</a>)<span class="comment">//Unblock new regular clients from connecting.</span></div><div class="line">        {</div><div class="line">            ret = <a class="code" href="uds_8h.html#a579487b86069a0a066bf6973f3d94dd7">udsSetNewConnectionsBlocked</a>(<span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</div><div class="line">            printf(<span class="stringliteral">&quot;udsSetNewConnectionsBlocked() for disabling blocking returned 0x%08x.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)ret);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(kDown &amp; <a name="a54"></a><a class="code" href="hid_8h.html#a84627a72058502328269676b81780f89aa3ec8a2ffd5b0e200db5ebe7b65515ff">KEY_R</a>)</div><div class="line">        {</div><div class="line">            ret = <a name="a55"></a><a class="code" href="uds_8h.html#a589315923507b9180d2e20a5694f577a">udsEjectSpectator</a>();</div><div class="line">            printf(<span class="stringliteral">&quot;udsEjectSpectator() returned 0x%08x.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)ret);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(kDown &amp; <a class="code" href="hid_8h.html#a84627a72058502328269676b81780f89aece16de35a5ea11f9b228c9376bebc62">KEY_L</a>)</div><div class="line">        {</div><div class="line">            ret = <a name="a56"></a><a class="code" href="uds_8h.html#a715815015bb8ddf709d3f85553e8ae4a">udsAllowSpectators</a>();</div><div class="line">            printf(<span class="stringliteral">&quot;udsAllowSpectators() returned 0x%08x.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)ret);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span>(<a class="code" href="uds_8h.html#a3e5c7256539d252195695c5503d64255">udsWaitConnectionStatusEvent</a>(<span class="keyword">false</span>, <span class="keyword">false</span>))</div><div class="line">        {</div><div class="line">            printf(<span class="stringliteral">&quot;Constatus event signaled.\n&quot;</span>);</div><div class="line">            print_constatus();</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    free(tmpbuf);</div><div class="line">    tmpbuf = NULL;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span>(con_type)</div><div class="line">    {</div><div class="line">        <a class="code" href="uds_8h.html#a44092fac3eec0cb9402fd903dc2fff81">udsDestroyNetwork</a>();</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <a class="code" href="uds_8h.html#a300ee4358ee07e1b08dea6e1908e72a6">udsDisconnectNetwork</a>();</div><div class="line">    }</div><div class="line">    <a class="code" href="uds_8h.html#a0478019d97df6c5754cae576b2fecbbd">udsUnbind</a>(&amp;bindctx);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main()</div><div class="line">{</div><div class="line">    <a class="code" href="types_8h.html#ac830bf5a4f2cf8273f61ab99a46cf163">Result</a> ret=0;</div><div class="line"></div><div class="line">    <a name="a57"></a><a class="code" href="gfx_8h.html#a236a005ae029247c8bfe4a4a649206fc">gfxInitDefault</a>();</div><div class="line">    <a name="a58"></a><a class="code" href="console_8h.html#a8e014e84f81ff901ca62d7669a8c8de8">consoleInit</a>(<a name="a59"></a><a class="code" href="gfx_8h.html#a356112d87f5cf6bbba3ea3b6b010e09caf9d44178134d07cf9c5923200e14af09">GFX_TOP</a>, NULL);</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;libctru UDS local-WLAN demo.\n&quot;</span>);</div><div class="line"></div><div class="line">    ret = <a name="a60"></a><a class="code" href="uds_8h.html#a7b9dd66fad0387daa7cc1a0803093161">udsInit</a>(0x3000, NULL);<span class="comment">//The sharedmem size only needs to be slightly larger than the total recv_buffer_size for all binds, with page-alignment.</span></div><div class="line">    <span class="keywordflow">if</span>(<a class="code" href="result_8h.html#a0b5d96e53599ca10d46297ba05e20b62">R_FAILED</a>(ret))</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;udsInit failed: 0x%08x.\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)ret);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        uds_test();</div><div class="line">        <a name="a61"></a><a class="code" href="uds_8h.html#a0c4ec11a4ba9281c96528fdd2340e169">udsExit</a>();</div><div class="line">    }</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;Press START to exit.\n&quot;</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Main loop</span></div><div class="line">    <span class="keywordflow">while</span> (<a name="a62"></a><a class="code" href="apt_8h.html#a84808c36d9a8c389896ecf241c7f89cb">aptMainLoop</a>())</div><div class="line">    {</div><div class="line">        <a class="code" href="gspgpu_8h.html#abf0a992835649b5fe90e95d8a58b8c45">gspWaitForVBlank</a>();</div><div class="line">        <a class="code" href="hid_8h.html#abbbf0e1f3a79a75e459e19f85a66bee6">hidScanInput</a>();</div><div class="line"></div><div class="line">        <a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> kDown = <a class="code" href="hid_8h.html#aa2cababf764bf0b4297dc2e2fffe2a76">hidKeysDown</a>();</div><div class="line">        <span class="keywordflow">if</span> (kDown &amp; <a name="a63"></a><a class="code" href="hid_8h.html#a84627a72058502328269676b81780f89a616a1f5c4ed36080ca954453084aea3b">KEY_START</a>)</div><div class="line">            <span class="keywordflow">break</span>; <span class="comment">// break in order to return to hbmenu</span></div><div class="line"></div><div class="line">        <span class="comment">// Flush and swap framebuffers</span></div><div class="line">        <a name="a64"></a><a class="code" href="gfx_8h.html#aea1808bd74fe0c00f9794e455fc8499b">gfxFlushBuffers</a>();</div><div class="line">        <a name="a65"></a><a class="code" href="gfx_8h.html#a0f338920111994110975dc0d1360bb1f">gfxSwapBuffers</a>();</div><div class="line">    }</div><div class="line"></div><div class="line">    <a name="a66"></a><a class="code" href="gfx_8h.html#aa446ccfdfdd4c575e648956ae96f2a3b">gfxExit</a>();</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
